"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _htmlGenerator = _interopRequireDefault(require("./htmlGenerator"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const fs = require('fs-extra');

const path = require('path');

const moment = require('moment');

const logger = require('@log4js-node/log4js-api');

function walk(dir, extensions, filelist = []) {
  const files = fs.readdirSync(dir);
  files.forEach(function (file) {
    const filepath = path.join(dir, file);
    const stat = fs.statSync(filepath);

    if (stat.isDirectory()) {
      filelist = walk(filepath, extensions, filelist);
    } else {
      extensions.forEach(function (extension) {
        if (file.indexOf(extension) == file.length - extension.length) {
          filelist.push(filepath);
        }
      });
    }
  });
  return filelist;
}

class ReportAggregator {
  constructor(opts) {
    opts = Object.assign({}, {
      outputDir: 'reports/html-reports/',
      filename: 'master-report.html',
      reportTitle: 'Test Master Report',
      showInBrowser: false,
      templateFilename: path.resolve(__dirname, '../templates/wdio-html-reporter-template.hbs'),
      templateFuncs: {},
      browserName: "not specified",
      LOG: null
    }, opts);
    this.options = opts;

    if (!this.options.LOG) {
      this.options.LOG = logger.getLogger("default");
    }

    this.options.reportFile = path.join(process.cwd(), this.options.outputDir, this.options.filename);
    this.reports = [];
  }

  clean() {
    fs.emptyDirSync(this.options.outputDir);
  }

  readJsonFiles() {
    return walk(this.options.outputDir, [".json"]);
  }

  log(message, object) {
    if (this.options.LOG) {
      this.options.LOG.debug(message + object);
    }
  }

  async createReport() {
    if (this.options.LOG) {
      this.options.LOG.debug("Report Aggregation started");
    }

    let metrics = {
      passed: 0,
      skipped: 0,
      failed: 0,
      start: new moment(),
      end: new moment(),
      duration: 0
    };
    let suites = [];
    let specs = [];
    let files = this.readJsonFiles();

    for (let i = 0; i < files.length; i++) {
      try {
        let filename = files[i];
        let report = JSON.parse(fs.readFileSync(filename));

        if (!report.info || !report.info.specs) {
          this.options.LOG.error("report structure in question, no info or info.specs ", JSON.stringify(report));
          this.options.LOG.info("report content: ", JSON.stringify(report));
        }

        report.info.specs.forEach(spec => {
          specs.push(spec);
        });
        this.reports.push(report);
        metrics.passed += report.metrics.passed;
        metrics.failed += report.metrics.failed;
        metrics.skipped += report.metrics.skipped;

        for (let k = 0; k < report.suites.length; k++) {
          let suite = report.suites[k];
          let start = moment.utc(suite.start);

          if (start.isSameOrBefore(metrics.start)) {
            metrics.start = start;
          }

          let end = moment.utc(suite.end);

          if (end.isAfter(metrics.end)) {
            metrics.end = end;
          }

          suites.push(suite);
        }
      } catch (ex) {
        console.error(ex);
      }
    }

    if (!this.reports || !this.reports.length) {
      // the test failed hard at the beginning.  Create a dummy structure to get through html generation
      let report = {
        "info": {
          "cid": "The execution of the test suite has failed before report generation was started.  Please look at the logs to determine the error, this is likely an issue with your configuration files.",
          "config": {
            "hostname": "localhost"
          },
          "specs": [],
          "suites": [{
            "uid": "Test Start Failure",
            "title": "Test Start Failure",
            "type": "suite",
            "tests": []
          }]
        }
      };
      this.reports = [];
      this.reports.push(report);
    }

    let duration = metrics.end.diff(metrics.start);
    metrics.duration = moment.duration(duration, "milliseconds").format('hh:mm:ss.SS', {
      trim: false
    });
    metrics.start = metrics.start.format();
    metrics.end = metrics.end.format();
    const reportOptions = {
      data: {
        info: this.reports[0].info,
        specs: specs,
        metrics: metrics,
        suites: suites,
        title: this.options.reportTitle,
        browserName: this.options.browserName
      },
      outputDir: this.options.outputDir,
      reportFile: this.options.reportFile,
      templateFilename: this.options.templateFilename,
      LOG: this.options.LOG,
      templateFuncs: this.options.templateFuncs,
      showInBrowser: this.options.showInBrowser
    };

    if (this.options.LOG) {
      this.options.LOG.debug("Aggregated " + specs.length + " specs, " + suites.length + " suites, " + this.reports.length + " reports, ");
    }

    _htmlGenerator.default.htmlOutput(reportOptions);

    reportOptions.LOG.debug("Report Aggregation completed");
  }

}

var _default = ReportAggregator;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXBvcnRBZ2dyZWdhdG9yLmpzIl0sIm5hbWVzIjpbImZzIiwicmVxdWlyZSIsInBhdGgiLCJtb21lbnQiLCJsb2dnZXIiLCJ3YWxrIiwiZGlyIiwiZXh0ZW5zaW9ucyIsImZpbGVsaXN0IiwiZmlsZXMiLCJyZWFkZGlyU3luYyIsImZvckVhY2giLCJmaWxlIiwiZmlsZXBhdGgiLCJqb2luIiwic3RhdCIsInN0YXRTeW5jIiwiaXNEaXJlY3RvcnkiLCJleHRlbnNpb24iLCJpbmRleE9mIiwibGVuZ3RoIiwicHVzaCIsIlJlcG9ydEFnZ3JlZ2F0b3IiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJPYmplY3QiLCJhc3NpZ24iLCJvdXRwdXREaXIiLCJmaWxlbmFtZSIsInJlcG9ydFRpdGxlIiwic2hvd0luQnJvd3NlciIsInRlbXBsYXRlRmlsZW5hbWUiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwidGVtcGxhdGVGdW5jcyIsImJyb3dzZXJOYW1lIiwiTE9HIiwib3B0aW9ucyIsImdldExvZ2dlciIsInJlcG9ydEZpbGUiLCJwcm9jZXNzIiwiY3dkIiwicmVwb3J0cyIsImNsZWFuIiwiZW1wdHlEaXJTeW5jIiwicmVhZEpzb25GaWxlcyIsImxvZyIsIm1lc3NhZ2UiLCJvYmplY3QiLCJkZWJ1ZyIsImNyZWF0ZVJlcG9ydCIsIm1ldHJpY3MiLCJwYXNzZWQiLCJza2lwcGVkIiwiZmFpbGVkIiwic3RhcnQiLCJlbmQiLCJkdXJhdGlvbiIsInN1aXRlcyIsInNwZWNzIiwiaSIsInJlcG9ydCIsIkpTT04iLCJwYXJzZSIsInJlYWRGaWxlU3luYyIsImluZm8iLCJlcnJvciIsInN0cmluZ2lmeSIsInNwZWMiLCJrIiwic3VpdGUiLCJ1dGMiLCJpc1NhbWVPckJlZm9yZSIsImlzQWZ0ZXIiLCJleCIsImNvbnNvbGUiLCJkaWZmIiwiZm9ybWF0IiwidHJpbSIsInJlcG9ydE9wdGlvbnMiLCJkYXRhIiwidGl0bGUiLCJIdG1sR2VuZXJhdG9yIiwiaHRtbE91dHB1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QUF5QkosYUFBekI7O0FBQ0FBLElBQUFBLGFBQWEsQ0FBQzNDLEdBQWQsQ0FBa0JhLEtBQWxCLENBQXdCLDhCQUF4QjtBQUVIOztBQTVJa0I7O2VBK0lSM0IsZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgSHRtbEdlbmVyYXRvciBmcm9tIFwiLi9odG1sR2VuZXJhdG9yXCI7XHJcblxyXG5jb25zdCBmcyA9IHJlcXVpcmUoJ2ZzLWV4dHJhJyk7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XHJcbmNvbnN0IG1vbWVudCA9IHJlcXVpcmUoJ21vbWVudCcpO1xyXG5jb25zdCBsb2dnZXIgPSByZXF1aXJlKCdAbG9nNGpzLW5vZGUvbG9nNGpzLWFwaScpO1xyXG5cclxuZnVuY3Rpb24gIHdhbGsoZGlyLCBleHRlbnNpb25zICwgZmlsZWxpc3QgPSBbXSkge1xyXG4gICAgY29uc3QgZmlsZXMgPSBmcy5yZWFkZGlyU3luYyhkaXIpO1xyXG5cclxuICAgIGZpbGVzLmZvckVhY2goZnVuY3Rpb24gKGZpbGUpIHtcclxuICAgICAgICBjb25zdCBmaWxlcGF0aCA9IHBhdGguam9pbihkaXIsIGZpbGUpO1xyXG4gICAgICAgIGNvbnN0IHN0YXQgPSBmcy5zdGF0U3luYyhmaWxlcGF0aCk7XHJcblxyXG4gICAgICAgIGlmIChzdGF0LmlzRGlyZWN0b3J5KCkpIHtcclxuICAgICAgICAgICAgZmlsZWxpc3QgPSB3YWxrKGZpbGVwYXRoLCBleHRlbnNpb25zLCBmaWxlbGlzdCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZXh0ZW5zaW9ucy5mb3JFYWNoKGZ1bmN0aW9uIChleHRlbnNpb24pIHtcclxuICAgICAgICAgICAgICAgIGlmIChmaWxlLmluZGV4T2YoZXh0ZW5zaW9uKSA9PSBmaWxlLmxlbmd0aCAtIGV4dGVuc2lvbi5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICBmaWxlbGlzdC5wdXNoKGZpbGVwYXRoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIGZpbGVsaXN0O1xyXG59XHJcblxyXG5jbGFzcyBSZXBvcnRBZ2dyZWdhdG9yIHtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihvcHRzKSB7XHJcbiAgICAgICAgb3B0cyA9IE9iamVjdC5hc3NpZ24oe30sIHtcclxuICAgICAgICAgICAgb3V0cHV0RGlyOiAncmVwb3J0cy9odG1sLXJlcG9ydHMvJyxcclxuICAgICAgICAgICAgZmlsZW5hbWU6ICdtYXN0ZXItcmVwb3J0Lmh0bWwnLFxyXG4gICAgICAgICAgICByZXBvcnRUaXRsZTogJ1Rlc3QgTWFzdGVyIFJlcG9ydCcsXHJcbiAgICAgICAgICAgIHNob3dJbkJyb3dzZXI6IGZhbHNlLFxyXG4gICAgICAgICAgICB0ZW1wbGF0ZUZpbGVuYW1lOiBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vdGVtcGxhdGVzL3dkaW8taHRtbC1yZXBvcnRlci10ZW1wbGF0ZS5oYnMnKSxcclxuICAgICAgICAgICAgdGVtcGxhdGVGdW5jczoge30sXHJcbiAgICAgICAgICAgIGJyb3dzZXJOYW1lOiBcIm5vdCBzcGVjaWZpZWRcIixcclxuICAgICAgICAgICAgTE9HOiBudWxsXHJcbiAgICAgICAgfSwgb3B0cyk7XHJcbiAgICAgICAgdGhpcy5vcHRpb25zID0gb3B0cztcclxuICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5MT0cpIHtcclxuICAgICAgICAgICAgdGhpcy5vcHRpb25zLkxPRyA9IGxvZ2dlci5nZXRMb2dnZXIoXCJkZWZhdWx0XCIpICAgICAgO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLm9wdGlvbnMucmVwb3J0RmlsZSA9IHBhdGguam9pbihwcm9jZXNzLmN3ZCgpLCB0aGlzLm9wdGlvbnMub3V0cHV0RGlyLCB0aGlzLm9wdGlvbnMuZmlsZW5hbWUpO1xyXG4gICAgICAgIHRoaXMucmVwb3J0cyA9IFtdO1xyXG4gICAgfVxyXG5cclxuICAgIGNsZWFuKCkge1xyXG4gICAgICAgIGZzLmVtcHR5RGlyU3luYyh0aGlzLm9wdGlvbnMub3V0cHV0RGlyKTtcclxuICAgIH1cclxuXHJcblxyXG5cclxuICAgIHJlYWRKc29uRmlsZXMoKSB7XHJcbiAgICAgICAgcmV0dXJuIHdhbGsodGhpcy5vcHRpb25zLm91dHB1dERpciwgW1wiLmpzb25cIl0pO1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBsb2cobWVzc2FnZSxvYmplY3QpIHtcclxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLkxPRykge1xyXG4gICAgICAgICAgICB0aGlzLm9wdGlvbnMuTE9HLmRlYnVnKG1lc3NhZ2UgKyBvYmplY3QpIDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBhc3luYyBjcmVhdGVSZXBvcnQoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5MT0cpIHtcclxuICAgICAgICAgICAgdGhpcy5vcHRpb25zLkxPRy5kZWJ1ZyhcIlJlcG9ydCBBZ2dyZWdhdGlvbiBzdGFydGVkXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgbWV0cmljcyA9IHtcclxuICAgICAgICAgICAgcGFzc2VkOiAwLFxyXG4gICAgICAgICAgICBza2lwcGVkOiAwLFxyXG4gICAgICAgICAgICBmYWlsZWQ6IDAsXHJcbiAgICAgICAgICAgIHN0YXJ0IDogbmV3IG1vbWVudCgpLFxyXG4gICAgICAgICAgICBlbmQgOiBuZXcgbW9tZW50KCksXHJcbiAgICAgICAgICAgIGR1cmF0aW9uOiAwXHJcbiAgICAgICAgfTtcclxuICAgICAgICBsZXQgc3VpdGVzID0gW107XHJcbiAgICAgICAgbGV0IHNwZWNzID0gW107XHJcblxyXG4gICAgICAgIGxldCBmaWxlcyA9IHRoaXMucmVhZEpzb25GaWxlcygpO1xyXG5cclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZpbGVzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgZmlsZW5hbWUgPSBmaWxlc1tpXTtcclxuICAgICAgICAgICAgICAgIGxldCByZXBvcnQgPSBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhmaWxlbmFtZSkpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFyZXBvcnQuaW5mbyB8fCAhcmVwb3J0LmluZm8uc3BlY3MpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLm9wdGlvbnMuTE9HLmVycm9yKFwicmVwb3J0IHN0cnVjdHVyZSBpbiBxdWVzdGlvbiwgbm8gaW5mbyBvciBpbmZvLnNwZWNzIFwiICwgSlNPTi5zdHJpbmdpZnkocmVwb3J0KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLkxPRy5pbmZvKFwicmVwb3J0IGNvbnRlbnQ6IFwiICwgSlNPTi5zdHJpbmdpZnkocmVwb3J0KSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXBvcnQuaW5mby5zcGVjcy5mb3JFYWNoKChzcGVjKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgc3BlY3MucHVzaChzcGVjKSA7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuXHJcblxyXG4gICAgICAgICAgICAgICAgdGhpcy5yZXBvcnRzLnB1c2gocmVwb3J0KTtcclxuICAgICAgICAgICAgICAgIG1ldHJpY3MucGFzc2VkICs9IHJlcG9ydC5tZXRyaWNzLnBhc3NlZDtcclxuICAgICAgICAgICAgICAgIG1ldHJpY3MuZmFpbGVkICs9IHJlcG9ydC5tZXRyaWNzLmZhaWxlZDtcclxuICAgICAgICAgICAgICAgIG1ldHJpY3Muc2tpcHBlZCArPSByZXBvcnQubWV0cmljcy5za2lwcGVkO1xyXG5cclxuICAgICAgICAgICAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgcmVwb3J0LnN1aXRlcy5sZW5ndGg7IGsrKykge1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBzdWl0ZSA9IHJlcG9ydC5zdWl0ZXNba10gO1xyXG4gICAgICAgICAgICAgICAgICAgIGxldCBzdGFydCA9IG1vbWVudC51dGMoc3VpdGUuc3RhcnQpIDtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIHN0YXJ0LmlzU2FtZU9yQmVmb3JlKG1ldHJpY3Muc3RhcnQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1ldHJpY3Muc3RhcnQgPSAgc3RhcnQgO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBsZXQgZW5kID0gbW9tZW50LnV0YyhzdWl0ZS5lbmQpIDtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIGVuZC5pc0FmdGVyKG1ldHJpY3MuZW5kKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXRyaWNzLmVuZCA9ICBlbmQgO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBzdWl0ZXMucHVzaChzdWl0ZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGV4KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKCF0aGlzLnJlcG9ydHMgfHwgIXRoaXMucmVwb3J0cy5sZW5ndGggKSB7XHJcbiAgICAgICAgICAgIC8vIHRoZSB0ZXN0IGZhaWxlZCBoYXJkIGF0IHRoZSBiZWdpbm5pbmcuICBDcmVhdGUgYSBkdW1teSBzdHJ1Y3R1cmUgdG8gZ2V0IHRocm91Z2ggaHRtbCBnZW5lcmF0aW9uXHJcbiAgICAgICAgICAgIGxldCByZXBvcnQgPSB7XHJcbiAgICAgICAgICAgICAgICBcImluZm9cIiA6IHtcclxuICAgICAgICAgICAgICAgICAgICBcImNpZFwiOiBcIlRoZSBleGVjdXRpb24gb2YgdGhlIHRlc3Qgc3VpdGUgaGFzIGZhaWxlZCBiZWZvcmUgcmVwb3J0IGdlbmVyYXRpb24gd2FzIHN0YXJ0ZWQuICBQbGVhc2UgbG9vayBhdCB0aGUgbG9ncyB0byBkZXRlcm1pbmUgdGhlIGVycm9yLCB0aGlzIGlzIGxpa2VseSBhbiBpc3N1ZSB3aXRoIHlvdXIgY29uZmlndXJhdGlvbiBmaWxlcy5cIixcclxuICAgICAgICAgICAgICAgICAgICBcImNvbmZpZ1wiOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiaG9zdG5hbWVcIjogXCJsb2NhbGhvc3RcIlxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBcInNwZWNzXCI6IFtdLFxyXG4gICAgICAgICAgICAgICAgXCJzdWl0ZXNcIjogW1xyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgXCJ1aWRcIjogXCJUZXN0IFN0YXJ0IEZhaWx1cmVcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgXCJ0aXRsZVwiOiBcIlRlc3QgU3RhcnQgRmFpbHVyZVwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBcInR5cGVcIjogXCJzdWl0ZVwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBcInRlc3RzXCI6IFtdLFxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBdXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHRoaXMucmVwb3J0cyA9IFtdIDtcclxuICAgICAgICAgICAgdGhpcy5yZXBvcnRzLnB1c2gocmVwb3J0KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBkdXJhdGlvbiA9IG1ldHJpY3MuZW5kLmRpZmYobWV0cmljcy5zdGFydCkgO1xyXG4gICAgICAgIG1ldHJpY3MuZHVyYXRpb24gPSBtb21lbnQuZHVyYXRpb24oZHVyYXRpb24sIFwibWlsbGlzZWNvbmRzXCIpLmZvcm1hdCgnaGg6bW06c3MuU1MnLCB7dHJpbTogZmFsc2V9KTtcclxuICAgICAgICBtZXRyaWNzLnN0YXJ0ID0gbWV0cmljcy5zdGFydC5mb3JtYXQoKSA7XHJcbiAgICAgICAgbWV0cmljcy5lbmQgPSBtZXRyaWNzLmVuZC5mb3JtYXQoKSA7XHJcblxyXG4gICAgICAgIGNvbnN0IHJlcG9ydE9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICAgIGluZm86IHRoaXMucmVwb3J0c1swXS5pbmZvLFxyXG4gICAgICAgICAgICAgICAgc3BlY3M6c3BlY3MsXHJcbiAgICAgICAgICAgICAgICBtZXRyaWNzOiBtZXRyaWNzLFxyXG4gICAgICAgICAgICAgICAgc3VpdGVzOiBzdWl0ZXMsXHJcbiAgICAgICAgICAgICAgICB0aXRsZTogdGhpcy5vcHRpb25zLnJlcG9ydFRpdGxlLFxyXG4gICAgICAgICAgICAgICAgYnJvd3Nlck5hbWU6IHRoaXMub3B0aW9ucy5icm93c2VyTmFtZVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBvdXRwdXREaXI6IHRoaXMub3B0aW9ucy5vdXRwdXREaXIsXHJcbiAgICAgICAgICAgIHJlcG9ydEZpbGU6IHRoaXMub3B0aW9ucy5yZXBvcnRGaWxlLFxyXG4gICAgICAgICAgICB0ZW1wbGF0ZUZpbGVuYW1lOiB0aGlzLm9wdGlvbnMudGVtcGxhdGVGaWxlbmFtZSxcclxuICAgICAgICAgICAgTE9HIDogdGhpcy5vcHRpb25zLkxPRyxcclxuICAgICAgICAgICAgdGVtcGxhdGVGdW5jczogdGhpcy5vcHRpb25zLnRlbXBsYXRlRnVuY3MsXHJcbiAgICAgICAgICAgIHNob3dJbkJyb3dzZXI6IHRoaXMub3B0aW9ucy5zaG93SW5Ccm93c2VyLFxyXG5cclxuICAgICAgICB9O1xyXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMuTE9HKSB7XHJcbiAgICAgICAgICAgIHRoaXMub3B0aW9ucy5MT0cuZGVidWcoXCJBZ2dyZWdhdGVkIFwiICsgc3BlY3MubGVuZ3RoICsgXCIgc3BlY3MsIFwiICsgc3VpdGVzLmxlbmd0aCArIFwiIHN1aXRlcywgXCIgKyB0aGlzLnJlcG9ydHMubGVuZ3RoICsgXCIgcmVwb3J0cywgXCIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBIdG1sR2VuZXJhdG9yLmh0bWxPdXRwdXQocmVwb3J0T3B0aW9ucyk7XHJcbiAgICAgICAgcmVwb3J0T3B0aW9ucy5MT0cuZGVidWcoXCJSZXBvcnQgQWdncmVnYXRpb24gY29tcGxldGVkXCIpO1xyXG5cclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgUmVwb3J0QWdncmVnYXRvcjtcclxuIl19